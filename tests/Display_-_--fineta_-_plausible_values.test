#!/bin/sh
#
# Check that the estimated time counter can show the end time of day.

# Allow all tests to be skipped, e.g. during a release build
test "${SKIP_ALL_TESTS}" = "1" && exit 77

true "${testSubject:?not set - call this from 'make check'}"
true "${workFile1:?not set - call this from 'make check'}"

dd if=/dev/zero bs=100 count=1 2>/dev/null \
| "${testSubject}" -f -I -s 100 -i 0.1 -L 25 >/dev/null 2>"${workFile1}"

# Count the number of different ETA values there have been.
#
valueCount=$(tr '\r' '\n' < "${workFile1}" | tr -d ' ' | sed '/^$/d' | sort | uniq | wc -l | tr -dc '0-9')

# There should be at least 1 line of output.
#
if ! test "${valueCount}" -gt 0; then
	echo "no output found"
	exit 1
fi

# 8 or more different values - not OK.
#
if ! test "${valueCount}" -lt 8; then
	echo "more than 7 different values (${valueCount})"
	tr '\r' '\n' < "${workFile1}" | sed '/^ *$/d' | sort | uniq
	exit 1
fi

exit 0
